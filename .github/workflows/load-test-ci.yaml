name: CI Load Test
on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  load-test:
    runs-on: ubuntu-latest
    name: Load test on k8s with Kind
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          mkdir -p ~/.local/bin
          sudo mv ./kubectl ~/.local/bin/kubectl

          # Install Kind
          # For AMD64 / x86_64
          [ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.31.0/kind-linux-amd64
          # For ARM64
          [ $(uname -m) = aarch64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.31.0/kind-linux-arm64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create Kind Cluster
        run: |
          kind create cluster --name load-test-cluster --config k8s/kind-config.yaml
          kubectl cluster-info
          kubectl get nodes
          kubectl label node load-test-cluster-control-plane ingress-ready=true

      - name: Install Nginx Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/kind/deploy.yaml

          # Wait for ingress-nginx controller to be ready
          kubectl wait --namespace ingress-nginx \
              --for=condition=ready pod \
              --selector=app.kubernetes.io/component=controller \
              --timeout=120s

          # Wait for ingress-nginx admission webhook job to complete
          kubectl wait \
            --namespace ingress-nginx \
            --for=condition=complete job \
            --selector=app.kubernetes.io/component=admission-webhook \
            --timeout=120s

          # Wait for the webhook service endpoints to be ready
          echo "Waiting for webhook service to have endpoints..."
          until kubectl get endpoints -n ingress-nginx ingress-nginx-controller-admission -o jsonpath='{.subsets[*].addresses[*].ip}' | grep -q .; do
            echo "Webhook endpoints not ready yet, waiting..."
            sleep 2
          done

          echo "âœ… Webhook service is ready!"

          # Added few extra seconds for the webhook to be fully operational
          sleep 10

      - name: Verify ingress controller installation
        run: |
          # Confirm IngressClass resource exists
          kubectl get ingressclass nginx -o jsonpath='{.metadata.name}' | grep -q nginx
          echo "âœ… IngressClass 'nginx' is available"

      - name: Deploy workloads
        run: |
          kubectl create namespace ci-load-test
          kubectl config set-context --current --namespace=ci-load-test
          kubectl apply -f k8s/bar-deployment.yaml -f k8s/foo-deployment.yaml -f k8s/ingress.yaml

      - name: Verify Pods are Running
        run: |
          # Wait for deployments to be available
          kubectl wait --for=condition=available --timeout=120s deployment/foo -n ci-load-test
          kubectl wait --for=condition=available --timeout=120s deployment/bar -n ci-load-test

          # Display cluster state for debugging
          echo "ðŸ“Š Cluster State:"
          kubectl get pods,svc,ingress,endpoints -n ci-load-test -o wide

          echo "âœ… Workloads are ready"

      - name: Verify ingress routing (smoke test)
        run: |
          # Wait for service endpoints to be populated
          echo "Waiting for service endpoints..."
          kubectl -n ci-load-test wait \
            --for=jsonpath='{.subsets[*].addresses[*].ip}' \
            endpoints/foo \
            --timeout=60s

          kubectl -n ci-load-test wait \
            --for=jsonpath='{.subsets[*].addresses[*].ip}' \
            endpoints/bar \
            --timeout=60s

          # Wait for ingress to sync and route traffic (with retry logic)
          echo "Waiting for ingress to serve traffic..."
          for i in {1..10}; do
          RESPONSE_FOO=$(curl -s -H "Host: foo.localhost" http://localhost:8080/ || true)
          RESPONSE_BAR=$(curl -s -H "Host: bar.localhost" http://localhost:8080/ || true)

          if [ "$RESPONSE_FOO" = "foo" ] && [ "$RESPONSE_BAR" = "bar" ]; then
              echo "âœ… Ingress routing is ready"
              break
            fi

          echo "Ingress not ready yet (attempt $i), retrying..."
          sleep 2
          done

      - name: Install K6 for load Testing
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run Random load test
        run: |
          k6 run --summary-export=summary.json scripts/loadtest.js

      - name: Format load test report
        run: |
          python3 scripts/format-report.py

      - name: Post load test results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const body = fs.readFileSync('report.md', 'utf8');

            github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
            });
